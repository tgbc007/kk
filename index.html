
 
<头>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频播放APP（强制更新版）</title>
    <link href="https://vjs.zencdn.net/8.6.1/video-js.css" rel="stylesheet">
    <script src="https://vjs.zencdn.net/8.6.1/video.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.14/dist/hls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <样式>
        /* 样式部分与原代码一致，无需修改 */

        body { font-family: Arial, sans-serif; padding: 20px; }

            width: 100%; 
            height: 100px; 
            line-height: 100px; 
            text-align: center; 
            border: 2px dashed #ff6700; 
            color: #ff6700; 
            font-size: 18px; 
            margin-bottom: 20px; 
            background: #fff8f0;
        }

            position: relative; 
            width: 100%; 
            max-width: 1200px; 
            margin: 0 auto; 
            aspect-ratio: 16/9; 
            background: #ccc; 
            opacity: 0.5; 
            pointer-events: none; 
        }
        .video-js .vjs-download-control { display: none !important; }
        .按钮组 { 
            最大宽度：1200像素；
            边距：15像素 自动；
            显示：弹性；
            间隙：15像素；
        输入：}
        .下一个按钮, .组按钮 { 
             
            边框：无；
            边框半径：4像素；
            cursor: not-allowed; 
            font-size: 16px; 
            background: #999; 
            color: #fff; 
            opacity: 0.7; 
            pointer-events: none; 
        }
        .video-list { 
            max-width: 1200px; 
            margin: 20px auto; 
            border: 1px solid #eee; 
            border-radius: 4px; 
            overflow: hidden; 
            display: none;
        }
        .list-header { 
            padding: 12px; 
            background: #f5f5f5; 
            font-weight: bold; 
        }
        .list-item { 
            padding: 12px; 
            display: flex; 
            align-items: center; 
            border-top: 1px solid #eee; 
            cursor: pointer;
        }
        .list-item:hover { background: #fafafa; }
        .date-red { color: #e74c3c; margin-left: 8px; }
        .load-tip { 
            text-align: center; 
            padding: 20px; 
            color: #666; 
            max-width: 1200px; 
            margin: 0 auto; 
            display: none;
        }
        .force-update-modal {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.9); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 9999; 
        }
        .update-content {
            background: #fff; 
            padding: 40px 30px; 
            border-radius: 8px; 
            width: 90%; 
            max-width: 500px; 
            text-align: center;
        }
        .update-title { 
            font-size: 24px; 
            color: #e74c3c; 
            margin-bottom: 20px; 
            font-weight: bold;
        }
        .update-desc { 
            margin-bottom: 30px; 
            line-height: 1.8; 
            font-size: 16px; 
            color: #333;
        }
        .update-desc span { color: #e74c3c; font-weight: bold; }
        .force-update-btn {
            width: 100%; 
            padding: 15px; 
            background: #e74c3c; 
            color: #fff; 
            border: none; 
            border-radius: 4px; 
            font-size: 18px; 
            cursor: pointer; 
            font-weight: bold;
        }
        .force-update-btn:hover { background: #c0392b; }
    </style>
</head>
<body>
    <!-- 页面结构与原代码一致，无需修改 -->
    <div class="ad-slot">【广告位招租】</div>
    <div class="player-container">
        <video id="video-player" class="video-js vjs-big-play-centered" controls preload="auto"></video>
    </div>
    <div class="btn-group">
        <button class="next-btn" onclick="playNextVideo()">下一个视频</button>
        <button class="group-btn" onclick="window.open('https://qun.qq.com/universal-share/share?ac=1&authKey=bH%2B1KyzX4WfhLWw1DijY0fE4UkVhnwegk1RB9LxR%2FqfVVvV6dWOqBO0CAjZiLAId&busi_data=eyJncm91cENvZGUiOiI3MzMzMTQ3NjQiLCJ0b2tlbiI6ImFIYjdMcDhsdnlqSEc4NjRIMmZ3SDIvZkc0S2dSenRnWXFVbFVzM01HQmwwT25TY3IyK1pRMVN1N21FNzFib20iLCJ1aW4iOiIxNzk1ODUyNTU5In0%3D&data=urNE9WigmXAvr-uFjHCIN7gLzULuz2itgIkc0Bxt07ytjRpFVb1nwiH7miG-PFobwd2AWThYePcOpnQq79PS9w&svctype=4&tempid=h5_group_info', '_blank')">加群获取最新资源</button>
    </div>
    <div class="load-tip" id="load-tip">正在加载视频列表，请稍候...</div>
    <div class="video-list" id="video-list">
        <div class="list-header">视频列表</div>
        <div id="list-container"></div>
    </div>
    <div class="force-update-modal" id="force-update-modal" style="display: none;">
        <div class="update-content">
            <h3 class="update-title">⚠️ 重要更新，须更新后使用</h3>
            <div class="update-desc">
                <p>当前版本：<span id="current-ver"></span>（已过期）</p>
                <p>最新版本：<span id="latest-ver"></span></p>
                <p>更新内容：<span id="update-log"></span></p>
                <p style="margin-top: 15px; color: #e74c3c;">不更新将无法观看！</p>
            </div>
            <button class="force-update-btn" onclick="forceRefreshUpdate()">立即刷新更新</button>
        </div>
    </div>

    <script>
        let videoList = [];
        let currentIndex = 0;
        const CURRENT_VERSION = "1.0.0"; 
        const EXCEL_FILE_URL = "video-list.xlsx";
        const UPDATE_JSON_URL = "https://wyw1.netlify.app/update.json"; 
        let hasNewVersion = false; 
        let updateChecked = false; // 新增：避免重复检测更新

        // 1. 初始化播放器（不变）
        const player = videojs('video-player', {
            autoplay: false,
            controls: true,
            responsive: true,
            fluid: true,
            sources: [],
            controlBar: { downloadControl: false },
            muted: false
        });

        // 2. 页面加载：优化更新检测逻辑（关键修正）
        window.onload = function() {
            document.getElementById('current-ver').textContent = CURRENT_VERSION;
            // 优先注册SW，SW注册成功后再检测更新（避免重复）
            registerServiceWorker().then(() => {
                if (!updateChecked) {
                    checkUpdateWithoutSW();
                }
            }).catch(() => {
                // SW注册失败，走兼容模式
                if (!updateChecked) {
                    checkUpdateWithoutSW();
                }
            });
        };

        // 3. 注册Service Worker（不变）
        function registerServiceWorker() {
            return new Promise((resolve, reject) => {
                if (!('serviceWorker' in navigator)) {
                    reject(); 
                    return;
                }
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log("Service Worker注册成功");
                        // 监听SW的更新消息
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    fetch(UPDATE_JSON_URL, { cache: 'no-store' })
                                        .then(res => res.json())
                                        .then(updateData => {
                                            if (compareVersion(updateData.latestVersion, CURRENT_VERSION) > 0) {
                                                updateChecked = true;
                                                triggerForceUpdate(updateData);
                                            }
                                            resolve();
                                        });
                                }
                            });
                        });
                        resolve();
                    })
                    .catch(error => {
                        console.error("Service Worker注册失败：", error);
                        reject(error);
                    });
            });
        }

        // 4. 兼容模式检测更新（不变）
        function checkUpdateWithoutSW() {
            return new Promise((resolve) => {
                fetch(UPDATE_JSON_URL, { cache: 'no-store' }) // 关键：禁止缓存update.json
                    .then(res => {
                        if (!res.ok) throw new Error("获取更新信息失败");
                        return res.json();
                    })
                    .then(updateData => {
                        updateChecked = true;
                        if (compareVersion(updateData.latestVersion, CURRENT_VERSION) > 0) {
                            triggerForceUpdate(updateData);
                        } else {
                            // 无新版本，启用功能
                            if (!hasNewVersion) {
                                enableAllFeatures();
                                loadExcelFromServer();
                            }
                        }
                        resolve();
                    })
                    .catch(error => {
                        console.error("兼容模式更新检测失败：", error);
                        updateChecked = true;
                        triggerForceUpdate({
                            latestVersion: CURRENT_VERSION,
                            updateLog: "网络异常，无法验证版本，请检查网络后刷新重试"
                        });
                        resolve();
                    });
            });
        }

        // 5. 触发强制更新（不变）
        function triggerForceUpdate(updateData) {
            hasNewVersion = true;
            document.getElementById('latest-ver').textContent = updateData.latestVersion;
            document.getElementById('update-log').textContent = updateData.updateLog || "修复重要问题，提升使用体验";
            document.getElementById('force-update-modal').style.display = 'flex';
            disableAllFeatures();
        }

        // 6. 启用所有功能（不变）
        function enableAllFeatures() {
            document.querySelector('.player-container').style.opacity = "1";
            document.querySelector('.player-container').style.pointerEvents = "auto";
            const btns = document.querySelectorAll('.next-btn, .group-btn');
            btns.forEach(btn => {
                btn.style.background = btn.classList.contains('next-btn') ? '#2c3e50' : '#e74c3c';
                btn.style.opacity = "1";
                btn.style.cursor = "pointer";
                btn.style.pointerEvents = "auto";
            });
            document.getElementById('load-tip').style.display = "block";
        }

        // 7. 禁用所有功能（不变）
        function disableAllFeatures() {
            document.querySelector('.player-container').style.opacity = "0.5";
            document.querySelector('.player-container').style.pointerEvents = "none";
            const btns = document.querySelectorAll('.next-btn, .group-btn');
            btns.forEach(btn => {
                btn.style.background = "#999";
                btn.style.opacity = "0.7";
                btn.style.cursor = "not-allowed";
                btn.style.pointerEvents = "none";
            });
            document.getElementById('load-tip').style.display = "none";
            document.getElementById('video-list').style.display = "none";
        }

        // 8. 强制刷新更新（关键修正：激活新SW）
        function forceRefreshUpdate() {
            // 若有新SW等待激活，先激活再刷新
            if (navigator.serviceWorker.controller) {
                navigator.serviceWorker.ready.then(registration => {
                    if (registration.waiting) {
                        registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                        registration.waiting.addEventListener('statechange', () => {
                            if (registration.waiting.state === 'activated') {
                                window.location.reload(true); // 强制刷新
                            }
                        });
                    } else {
                        window.location.reload(true);
                    }
                });
            } else {
                window.location.reload(true);
            }
        }

        // 9. Excel加载和视频播放功能（不变）
        function loadExcelFromServer() {
            fetch(EXCEL_FILE_URL)
                .then(response => response.arrayBuffer())
                .then(buffer => {
                    const workbook = XLSX.read(new Uint8Array(buffer), { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(
                        workbook.Sheets[workbook.SheetNames[0]],
                        { header: ['序号', '视频名称', '视频地址', '添加日期'], skipEmptyRows: true }
                    );
                    videoList = jsonData.slice(1).filter(item => item['视频地址']);
                    if (videoList.length > 0) {
                        renderVideoList();
                        playVideo(0);
                        document.getElementById('load-tip').style.display = "none";
                        document.getElementById('video-list').style.display = "block";
                    } else {
                        document.getElementById('load-tip').textContent = "Excel中无有效视频";
                    }
                })
                .catch(error => {
                    document.getElementById('load-tip').textContent = `加载失败：${error.message}`;
                });
        }

        function renderVideoList() {
            const container = document.getElementById('list-container');
            container.innerHTML = '';
            videoList.forEach((item, index) => {
                const listItem = document.createElement('div');
                listItem.className = 'list-item';
                listItem.onclick = () => playVideo(index);
                listItem.innerHTML = `
                    <span style="width: 60px; margin-right: 15px;">${item['序号'] || index + 1}</span>
                    <span>${item['视频名称'] || '未命名'}<span class="date-red">(${item['添加日期'] || '未知'})</span></span>
                `;
                container.appendChild(listItem);
            });
        }

        function playVideo(index) {
            if (index < 0 || index >= videoList.length || hasNewVersion) return;
            currentIndex = index;
            const video = videoList[index];
            player.pause();
            player.src({
                src: video['视频地址'],
                type: video['视频地址'].endsWith('.m3u8') ? 'application/x-mpegURL' : 'video/mp4'
            });
            player.load();
            player.play();
            document.querySelectorAll('.list-item').forEach((item, i) => {
                item.style.background = i === currentIndex ? '#e3f2fd' : 'transparent';
            });
        }

        function playNextVideo() {
            if (hasNewVersion) return;
            const nextIndex = currentIndex + 1 >= videoList.length ? 0 : currentIndex + 1;
            playVideo(nextIndex);
        }

        // 版本对比工具（不变）
        function compareVersion(a, b) {
            const aArr = a.split('.').map(Number);
            const bArr = b.split('.').map(Number);
            const maxLen = Math.max(aArr.length, bArr.length);
            for (let i = 0; i < maxLen; i++) {
                const aVal = aArr[i] || 0;
                const bVal = bArr[i] || 0;
                if (aVal !== bVal) return aVal - bVal;
            }
            return 0;
        }

        // 监听SW消息（不变）
        navigator.serviceWorker.addEventListener('message', (event) => {
            if (event.data.type === 'UPDATE_AVAILABLE') {
                updateChecked = true;
                triggerForceUpdate(event.data.updateData);
            }
        });
    </script>
</body>
</html>
